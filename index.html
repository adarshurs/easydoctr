  <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <title>Get Site Info</title>
  <style type="text/css">
  
  html, body{
    height: 100%;
  }

  body{
    background-color: black;
  }

  .messageboxcont{
    position: absolute;
    background-color:rgba(55,0,0,0.5);
    height: 60%;
    min-height: 400px;
    width:600px;
    top: 35%;
    right: 1%;    
    z-index: 100;
  }

  .msgbox{
    height: 100%;
    width: 100%;    
    background: #fff;
    border: 1px solid #ccc;
    overflow: hidden;
    z-index: 100;
  }
  
  .messageboxheader,.messageboxfooter{
    height: 40px;
    width: 100%;
    background: #404040;
    display: inline-block;
  }

  .messageboxfooter{
    background: #e3e3e3;
  }

  .active{
    background: #428bca;
  }

  .messageboxtitle{
    height: 20px;
    width: 150px;
    float: left;
    padding: 10px;
    color: #fff;
    font-size: 14px;    
  }
  .messageboxbtn{
    width: 30px;
    margin-top: 5px;
    text-align: center;
    margin-right:5px;
    float: right;
    color: #fff;    
    font-size: 18px;
    cursor: pointer;
  }

  .messageboxbtn:hover{
    background: #606060;
  }
  

  .group input {
    margin-left: 2%;
    width: 96%;
  }

  .messageboxcontent{
    width: 100%;
    height: 79%;
    min-height: 250px;
  }

  #recipients_box{
    width: 100%;
    min-width: 100%;
    max-width: 100%;
    height: auto;
    min-height: 40px;
    max-height: 80px;
  }

  #email_text_box{
    height: 100%;
    width: 100%;
    max-width: 100%;
    max-height: 100%;
    min-height: 100%;
    min-width: 100%; 
  }

  </style>
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
  <script type="text/javascript" src="js/jquery-2.0.3.js"></script>
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <script type="text/javascript">
      $(function(){

        var recipients = [];
        var isAllselected = false;

        var addrecipient = function(recipient){
          isRecipientAdded = false;
          
          $.each(recipients,function(index,patient){
              if (patient.name == recipient.name && patient.email == recipient.email) {
                    isRecipientAdded = true;
              };
          })
          
          if (!isRecipientAdded) {                        
            recipients.push(recipient);
            addRecipientToMessageBox();
          };
        }

        var removerecipient = function(recipient){
          //console.log(JSON.stringify(recipient));
          $.each(recipients,function(index,patient){             
             try{
                if (patient.name == recipient.name && patient.email == recipient.email ) {
                      recipients.splice(recipients.indexOf(patient),1);
                };
            }
            catch(error){}
          });
          addRecipientToMessageBox();
        }


        var addRecipientToMessageBox = function(){
          var rcpnts = "";
          //console.log(recipients);
          
          $.each(recipients,function(index,patient){
            if (patient.email) {rcpnts = rcpnts + patient.name.toString() +"<"+ patient.email.toString() +">"+"," };
          });

          $("#recipients_box").text(rcpnts);
        }


        $('.select').click(function(){
          var pat = $(this).parent().parent().children(".patient-info");
          var pat_info = {name:pat.children("h4").text(),email:pat.children(".email_add").text()}

          if ($(this).prop('checked') == false) {
            console.log(JSON.stringify(pat_info));
            removerecipient(pat_info);                
          }

          else{
            var emailid_pattern = /^\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,3}$/;

            if (!pat_info.email.match(emailid_pattern)) {                  
              alert("This patient do not have a valid e-mail address");
              $(this).prop('checked',false)
              return;
            }

            else{
              addrecipient(pat_info);
            }
          }
          //console.log(JSON.stringify(recipients));

        });

        $('#selectall').click(function(){
          recipients = [];

          if (isAllselected) {              
              var temp = $('.select').prop('checked',false);
              isAllselected = false;            
          }

          else{
              var temp = $('.select').prop('checked',true);                
              $('.patient-info').each(function(index,element){                    
                  recipients.push({name:$(this).children("h4").text(),email:$(this).children(".email_add").text()});
              });                
    
              isAllselected = true;
          }
          addRecipientToMessageBox();          

        });

        // if ($('.select').prop('checked') == true){
        //   console.log(this)
        // }

        $('#msgcls').click(function(){         
          $('.messageboxcont').addClass('hide');

        });

        $('#composemail').click(function(){         
          $('.messageboxcont').removeClass('hide');
        });


        $("#send_message").click(function(e){

          if (recipients.length <= 0) {
            alert("Please enter at least one patient email address");
            return;
          };
          
          $(this).addClass("active");
          var email_sub = $("#email_subject").text();
          var email_text = $("#email_text_box").text();

          if (email_sub == null) {
            alert("Email subject is empty!");
          };

          $.ajax({
            url:"/sendMessage",
            type:"post",
            data:{to:recipients, subject:email_sub,text:email_text},
            data:{email:"abhinav@practo.com"},
            beforeSend:function(){
              console.log(recipients);
            },
            success:function(d){
              console.log(d);
            },
            error:function(){
              console.log("error!");
            }
          })
        });
});
  </script>

  <body style="background-color:Gray;">

      <div class="messageboxcont">
        
        <div class="messageboxheader">
          <p class="messageboxtitle">New Message</p>
          <p id="msgcls" class="messageboxbtn">x</p>
          <p id="msgmin" class="messageboxbtn">_</p>        
        </div>
      
        <div class="msgbox">        
          <textarea class="form-control" placeholder="recipients" id="recipients_box"></textarea>         
          <input class="form-control" placeholder="subject" id="email_subject">            
      
          <div class="messageboxcontent">
            <textarea class="form-control" id="email_text_box"></textarea>
          </div>

          <div class="messageboxfooter">
            <input class="btn btn-primary" type="submit" id="send_message" value="send">
          </div>
        </div>

      </div>


<div class="container" style="height:100%;background-color:#fff;">
      
      <div class="jumbotron" style="height:20%;" >
        <h1>p-mail</h1>
        <p>An e-mail app for doctors from practo.</p>      
      </div>

      <div class="row" style="height:5%;min-height:60px;">
        
        <div class="col-md-3">
          <div class="functionscont" style="display:inline-block;height:100%; width:100%">
            <input id="composemail" type="button" class="btn btn-danger" value="compose">
            <input id="selectall" type="button" class="btn btn-primary" value="Select All">
          </div>
        </div>
      
        <div class="col-md-9" style="height:5%;" >

        </div>

      </div>


  
  <div class="row" style="height:70%;">      
    {% if patients %} 
      <div class="col-md-3" style="min-height:400px; height:100%;">
        <div class="panel panel-info" style="height:100%;">
          <div class="panel-heading">Patients</div>
          <div class="list-group scrollablediv" style="height:93%;overflow-x:hidden;overflow-y:scroll">
            {% for patient in patients %}        
              <a href="#" class="list-group-item" style="padding-left:2px;padding-right:0px;" >
                <div class="patients-list" style="display:inline-block;width:100%; height:80px;">
                  <span style="float:left;width:25%;height:100%;" class="input-group-addon">
                    <input style="margin-top:25px;" class="select" type="checkbox">
                  </span>
                  <div style="float:right;width:75%;height:100%;" class="patient-info list-group-item active">            
                    <h4>{{patient.Name}}</h4>
                    <p class="email_add">{{patient.Email_Address}}</p>               
                  </div>
                </div>
              </a>      
            {% endfor %}
          </div>        
        </div>
      </div>
    {% endif %}

      
    {% if all_mails %}                
      <div class="col-md-9" style="height:100%;">
        <div class="panel panel-info" style="height:100%;">
          <div class="panel-heading">All Messages</div>
          <div class="list-group scrollablediv" style="height:93%;overflow-x:hidden;overflow-y:scroll">
          {% for mail in all_mails %}
        
            <a href="#" class="list-group-item">
              <div class="mail" style="width:100%;display:inline-block;white-space:nowrap">
                <label style="width:25%;wrap:no-wrap;">{{mail.To}}</label>              
                <label style="width:55%;wrap:no-wrap;">{{mail.Message_Content}}</label>
             
              </div>
            </a>
        
          {% endfor %}
          </div>
        </div>
      </div>
    {% endif %}
  </div>
      
      
</div>
</body>
</html>